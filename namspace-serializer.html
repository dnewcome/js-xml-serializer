<!doctype html>
<html>
	<head>
		<script src="../js-shared-utils/util.js" type="text/javascript" language="javascript"></script>
		<script src="crmtest.js" type="text/javascript" language="javascript"></script>
		<script>
			function MyClass( str ) {
				this.mcAttr = str;	
			}

			var obj = {
				attr1: "one",
				attr2: 2,
				attr3: [ "three", 4 ],
				attr4: function() { var foo="bar"; },
				attr5: /.*/	
			};

			var obj2 = {
				attr1: "two",
				attr2: new MyClass( "hello" )
			};

			/*
			var rules = {
					Object: { nodetype: "element", nodename: "object", namespace: "http://example.org/Object", memberrules: {} },
					Array: { nodetype: "element", nodename: "array" },
					String: { nodetype: "attribute", nodename: "string" },
					MyType: { nodetype: "element", nodename: "object", memberrules: {
						member1: { nodetype: "element", nodename: "m1" }, 
						member2: { nodetype: "element", nodename: "m1" } 
					}},
			}
			*/

			// note that we have replaced the memberrules collection by using a default for the type 
			// as a parem __def__ 
			var rules = {
					Object: {
							__def__: { nodetype: "element", nodename: "obj", namespace: "http://example.org/" },
							attr1: { nodetype: "element", nodename: "first", namespace: "http://example.org/" }, 
							attr2: { nodetype: "element", nodename: "myc-attr2", namespace: "http://example.org/" } 
					},
					Array: {
							__def__: { nodetype: "element", nodename: "arr", namespace: "http://example.org/" },
							attr1: { nodetype: "element", nodename: "first", namespace: "http://example.org/" } 
					},
					String: {
							__def__: { nodetype: "element", nodename: "str", namespace: "http://example.org/" },
					},
					MyClass: {
							__def__: { nodetype: "element", nodename: "myc", namespace: "http://example.org/" }
					}
			}

			function serialize( parent, member, obj, rules, namespaces ) {
				var retval = "";
				var rule;
				if( parent != null ) {
					rule = rules[ parent.constructor.name ][ member ];
				}
				else {
					rule = rules[ obj.constructor.name ][ "__def__" ];
				}
				if( rule == undefined ) {
					rule = rules[ obj.constructor.name ][ "__def__" ];
				}
				// TODO: do we need this check?
				if( rule.nodetype == "element" ) {
					retval = "<" + rule.nodename + " xmlns:'" + rule.namespace + "' " + processAttributes( obj, rules, namespaces ) + ">\n";
					if( typeOf( obj ) == 'object' || typeOf( obj ) == 'array' ) {
						for( var item in obj ) {
							retval += serialize( obj, item, obj[item], rules, namespaces );	
						}
					}
					else {
						retval += obj + "\n";
					}
					retval += "</" + rule.nodename + ">\n";
				}
				return retval;
			}	
			
			function processAttributes( obj, rules, namespaces ) {
				var retval = "";
				for( var item in obj ) {
					var rule = rules[ obj.constructor.name ][ item ];
					if( rule && rule.nodetype == "attribute" ) {
						var prefix = namespaces[ rule.namespace ] || rule.namespace || "";
						if( prefix != "" ) {
							prefix += ":";
						}
						retval += prefix + rule.nodename + "='" + obj[ item ] + "'";
					}
				}
				return retval;
			}

			function init() {
				// console.log( serialize( null, null, obj2, rules ) );	
				console.log( serialize( null, null, execute, exrules, namespaces ) );	
			}
		</script>
	</head>
	<body onload="init();">
	</body>
</html>
